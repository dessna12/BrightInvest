@page "/excel-module"
@using BrightInvest.Application.Services.Excel
@using BrightInvest.Web.Services

@inject NavigationManager Navigation
@inject CustomHttpClientService CustomHttpClientService
@inject ExcelService ExcelService


<PageTitle>Excel</PageTitle>


<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h5">Upload Excel File</MudText>
        <InputFile OnChange="HandleFileUpload" accept=".xlsx" />
        <MudButton OnClick="ProcessFile" Disabled="@(_selectedFile == null)">Process File</MudButton>

        @if (_isProcessing)
        {
            <MudProgressCircular Indeterminate="true" />
        }
    </MudCardContent>
</MudCard>

@code {
    private IBrowserFile? _selectedFile;
    private bool _isProcessing = false;

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
    }

    private async Task ProcessFile()
    {
        if (_selectedFile == null)
            return;

        _isProcessing = true;

        await using var stream = _selectedFile.OpenReadStream();
        var assets = await ExcelService.ReadAssetsFromExcelAsync(stream);

        var httpClient = CustomHttpClientService.GetHttpClient();
        foreach (var asset in assets)
        {
            AssetCreateDto assetCreateDTO = 
                new AssetCreateDto(asset.Ticker, asset.Name, asset.Currency, asset.Country, asset.Sector);

            var response = await httpClient.PostAsJsonAsync("api/assets", assetCreateDTO);
        }

        _isProcessing = false;
        StateHasChanged();
    }
}